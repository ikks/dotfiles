#!/bin/bash
#
# Uses piper to read a text aloud
# https://github.com/OHF-Voice/piper1-gpl/
# No warranties
#
# Igor Támara
#
# To public domain
# 
# You can use this script as:
#
# echo "la voz de Daniela en argentino"  | digo

SERVER="localhost"
PORT=7040

API_URL="http://$SERVER:$PORT/"


function procesa() {
  JSON_DATA='{"text" : "'$1'" }'
  WAV_FILE=$(mktemp).wav
  TRANSLATION=$(curl -s -X POST -H "Content-Type: application/json" -d "$JSON_DATA" -o "$WAV_FILE" "$API_URL")
  if [ $TRANSLATION ]; then
    rm $WAV_FILE
    return 0
  else
    play -q $WAV_FILE 2>/dev/null
    rm $WAV_FILE
    return 1
  fi
}

input="-"
entrada=$(cat "$input")
if procesa "$entrada" ; then
  logger "[🌐] Starting decimelo-server"
  nohup decimelo-server >/dev/null 2>&1 & 
  sleep 4; procesa "$entrada"
fi

